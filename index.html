<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absensi QR Code</title>
<style>
/* === CSS tampilan sederhana === */
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 800px;
  margin: 20px auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #333;
}
video {
  width: 100%;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background: #007bff;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  margin: 5px;
}
button:hover {
  background: #0056b3;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: center;
}
th {
  background: #007bff;
  color: white;
}
.notice {
  background: #eaf4ff;
  padding: 10px;
  border-left: 4px solid #007bff;
  border-radius: 6px;
  margin-bottom: 10px;
}
</style>
</head>
<body>
<div class="container">
  <h1>Absensi Siswa Berbasis Scan QR</h1>
  <div class="notice">
    Arahkan kamera ke QR Code siswa.<br>
    Data absensi akan otomatis tersimpan di tabel di bawah.
  </div>

  <video id="video" autoplay></video>
  <canvas id="canvas" hidden></canvas>

  <div style="text-align:center;margin-top:10px;">
    <button id="startBtn">Mulai Kamera</button>
    <button id="stopBtn">Hentikan Kamera</button>
    <button id="exportBtn">Export CSV</button>
    <button id="resetBtn">Reset Data</button>
  </div>

  <table id="absensiTable">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>NIS / ID</th>
        <th>Waktu</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- JS Library untuk membaca QR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
// === Variabel global ===
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const tableBody = document.querySelector('#absensiTable tbody');
let stream = null;
let scanning = false;
let dataAbsensi = []; // Menyimpan data hasil scan

// === Fungsi memulai kamera ===
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    scanning = true;
    scanFrame();
  } catch (err) {
    alert('Gagal mengakses kamera: ' + err.message);
  }
}

// === Fungsi menghentikan kamera ===
function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  scanning = false;
}

// === Fungsi pemindaian frame ===
function scanFrame() {
  if (!scanning) return;
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height);
    if (code) {
      const text = code.data.trim();
      markAttendance(text);
      scanning = false;
      setTimeout(() => { scanning = true; scanFrame(); }, 1500);
      return;
    }
  }
  requestAnimationFrame(scanFrame);
}

// === Fungsi menambahkan data ke tabel ===
function markAttendance(text) {
  // Format QR bisa: "Nama|NIS" atau "ID:123"
  let nama = text, nis = '';
  if (text.includes('|')) {
    [nama, nis] = text.split('|');
  } else if (text.includes(':')) {
    const parts = text.split(':');
    nis = parts[1] || '';
    nama = 'Siswa ' + nis;
  }

  // Cek duplikasi (jika sudah absen)
  if (dataAbsensi.find(d => d.nis === nis)) {
    console.log('Sudah absen:', nis);
    return;
  }

  const waktu = new Date().toLocaleString();
  dataAbsensi.push({ nama, nis, waktu });

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${dataAbsensi.length}</td>
    <td>${nama}</td>
    <td>${nis}</td>
    <td>${waktu}</td>
  `;
  tableBody.appendChild(tr);
}

// === Fungsi export CSV ===
function exportCSV() {
  if (dataAbsensi.length === 0) {
    alert('Belum ada data untuk diexport.');
    return;
  }
  let csv = 'No,Nama,NIS/Waktu,Waktu\n';
  dataAbsensi.forEach((d, i) => {
    csv += `${i+1},"${d.nama}","${d.nis}","${d.waktu}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'rekap_absensi.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// === Fungsi reset data ===
function resetData() {
  if (confirm('Hapus semua data absensi?')) {
    dataAbsensi = [];
    tableBody.innerHTML = '';
  }
}

// === Event listener tombol ===
document.getElementById('startBtn').addEventListener('click', startCamera);
document.getElementById('stopBtn').addEventListener('click', stopCamera);
document.getElementById('exportBtn').addEventListener('click', exportCSV);
document.getElementById('resetBtn').addEventListener('click', resetData);
</script>
</body>
</html>






